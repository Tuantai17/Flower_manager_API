# LUỒNG HOẠT ĐỘNG CỦA SECURITY (REQUEST FLOW) - CHI TIẾT

**Tài liệu giải thích cơ chế thực thi từng bước (Step-by-Step Execution)**

Để giáo viên thấy bạn hiểu sâu, hãy trình bày luồng đi của một **Request cụ thể**.
Ví dụ: Admin muốn xem báo cáo doanh thu (`GET /api/admin/dashboard/overview`).

---

## BƯỚC 1: Frontend Gửi Request

Người dùng (Admin) bấm vào trang "Dashboard". Trình duyệt gửi request:

- **URL**: `http://localhost:8080/api/admin/dashboard/overview`
- **Method**: `GET`
- **Header**: `Authorization: Bearer eyJhbGciOiJIUzI1NiJ...` (Chuỗi Token)

---

## BƯỚC 2: Màng lọc (JwtAuthenticationFilter) - "Người bảo vệ"

Request chạm vào Server, người đầu tiên đón nó là `JwtAuthenticationFilter.java`.

- **File code**: `src/main/java/com/flower/manager/security/JwtAuthenticationFilter.java`
- **Hành động thực thi**:
  1.  Hàm `doFilterInternal()` được gọi.
  2.  Hàm `parseJwt(request)`: Lấy chuỗi token từ Header "Authorization", cắt bỏ chữ "Bearer ".
  3.  Hàm `jwtUtils.validateJwtToken(jwt)`: Giải mã token xem có đúng chữ ký của Server không? Có hết hạn chưa?
      - -> Kết quả: **Hợp lệ (True)**.
  4.  Hàm `jwtUtils.getUsernameFromJwtToken(jwt)`: Lấy ra tên đăng nhập, ví dụ `"admin"`.
  5.  Hàm `userDetailsService.loadUserByUsername("admin")`: Vào Database tìm ông admin này, lấy thông tin đầy đủ (bao gồm quyền `ROLE_ADMIN`).
  6.  **QUAN TRỌNG**: `SecurityContextHolder...setAuthentication(...)`: Lưu ông admin này vào bộ nhớ tạm (Security Context) của request này.
      - _Ý nghĩa_: "Đóng dấu" cho request này là "Đã xác thực bởi Admin".

---

## BƯỚC 3: Cấu hình Phân quyền (SecurityConfig) - "Trạm kiểm soát"

Sau khi đi qua Filter, request (giờ đã có dấu "Admin") đi đến trạm kiểm soát quyền hạn.

- **File code**: `src/main/java/com/flower/manager/config/SecurityConfig.java`
- **Hành động thực thi**:
  1.  Spring Security xem URL: `/api/admin/dashboard/overview`.
  2.  Nó dò trong hàm `filterChain`:
      ```java
      .requestMatchers("/api/admin/**").hasRole("ADMIN")
      ```
  3.  Nó kiểm tra "dấu" của request: "Ông này có phải `ROLE_ADMIN` không?"
      - -> Trong Security Context đang có `ROLE_ADMIN`.
      - -> **Kết quả**: CHẤP NHẬN (Allow).

  _(Nếu là User thường -> Không có ROLE_ADMIN -> Bị chặn lại, trả về lỗi 403 Forbidden)._

---

## BƯỚC 4: Controller Xử lý (DashboardController) - "Đích đến"

Cuối cùng, request mới được phép chạm vào code nghiệp vụ.

- **File code**: `src/main/java/com/flower/manager/controller/admin/DashboardController.java`
- **Hành động thực thi**:
  1.  Hàm `getOverview()` được kích hoạt.
  2.  Hàm này gọi xuống Service lấy doanh thu, đơn hàng...
  3.  Trả về kết quả JSON cho Frontend.

---

## TÓM TẮT ĐỂ TRẢ LỜI

"Thưa thầy, luồng đi là:

1.  **JwtAuthenticationFilter** chặn request lại, dùng **JwtUtils** để kiểm tra Token. Nếu đúng thì tìm User trong DB và lưu vào **SecurityContext**.
2.  Sau đó **SecurityConfig** kiểm tra xem User trong Context có đủ quyền (`hasRole`) để vào URL đó không.
3.  Nếu đủ quyền mới cho qua **Controller** xử lý."
